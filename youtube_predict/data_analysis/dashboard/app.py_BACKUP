import streamlit as st
import pandas as pd
import sqlite3
import plotly.express as px
from utils import load_data

# Configurar tÃ­tulo da pÃ¡gina e layout
st.set_page_config(page_title="Painel de AnÃ¡lise do YouTube", layout="wide")

# Criar tÃ­tulo da pÃ¡gina
st.title("ğŸ“Š Fabrica de Monstros - Painel de AnÃ¡lise de TendÃªncias")

# Carregar os dados do banco SQLite
df_videos = load_data()

# Converter a coluna 'published_at' para datetime
df_videos["published_at"] = pd.to_datetime(df_videos["published_at"], errors="coerce").dt.tz_localize(None)

# Criar filtros interativos no menu lateral
st.sidebar.header("ğŸ” Filtros")
video_type = st.sidebar.selectbox("Tipo de VÃ­deo", ["Todos", "Shorts", "Longos"])
date_range = st.sidebar.date_input("Selecione o perÃ­odo", [])

# Criar um DataFrame atualizado com base nos filtros
df_filtered = df_videos.copy()

# Aplicar filtro de tipo de vÃ­deo
if video_type != "Todos":
    df_filtered = df_filtered[df_filtered["video_type"] == video_type]

# Aplicar filtro de data corretamente
if date_range and len(date_range) == 2:
    start_date, end_date = pd.to_datetime(date_range).tz_localize(None)
    df_filtered = df_filtered[
        (df_filtered["published_at"] >= start_date) &
        (df_filtered["published_at"] <= end_date)
    ]

# ğŸ“¢ Se nenhum dado for encontrado apÃ³s a filtragem
if df_filtered.empty:
    st.warning("âš ï¸ Nenhum dado encontrado para os filtros aplicados.")
    st.stop()

# Criar mÃ©tricas principais
col1, col2 = st.columns([1, 3])
with col1:
    st.markdown("### ğŸ“Š Resumo dos Dados")
    st.metric("ğŸ¥ Total de VÃ­deos", df_filtered.shape[0])
    st.metric("ğŸ“ˆ MÃ©dia de VisualizaÃ§Ãµes", f"{df_filtered['views'].mean():,.0f}")
    st.metric("ğŸ‘ MÃ©dia de Likes", f"{df_filtered['likes'].mean():,.0f}")
    st.metric("â¤ï¸ MÃ©dia de Engajamento", round(df_filtered["likes_per_view"].mean(), 3))

# Criar abas para melhor organizaÃ§Ã£o
tab1, tab2, tab3, tab4, tab5 = st.tabs([
    "ğŸ“Š VisualizaÃ§Ãµes ao Longo do Tempo",
    "ğŸ“ˆ CorrelaÃ§Ã£o DuraÃ§Ã£o x VisualizaÃ§Ãµes",
    "ğŸ’¬ Engajamento: Shorts vs Longos",
    "ğŸ“… Desempenho por Dia da Semana",
    "ğŸ“ DistribuiÃ§Ã£o de DuraÃ§Ã£o"
])

# ğŸ“Š GrÃ¡fico de VisualizaÃ§Ãµes ao longo do tempo (corrigido)
with tab1:
    st.subheader("ğŸ“ˆ EvoluÃ§Ã£o das VisualizaÃ§Ãµes")

    if df_filtered.empty:
        st.warning("âš ï¸ Nenhum dado disponÃ­vel para este perÃ­odo.")
    else:
        df_plot = df_filtered.copy()

        # Certificar-se de que a data estÃ¡ formatada corretamente
        df_plot["published_at"] = pd.to_datetime(df_plot["published_at"]).dt.date

        # Garantir que a agregaÃ§Ã£o funcione corretamente para diferentes perÃ­odos
        df_plot = df_plot.groupby("published_at", as_index=False)["views"].sum()

        if df_plot.empty or df_plot["views"].sum() == 0:
            st.warning("âš ï¸ Nenhum dado disponÃ­vel no perÃ­odo selecionado.")
        else:
            fig = px.line(df_plot, x="published_at", y="views", title="VisualizaÃ§Ãµes ao Longo do Tempo")
            st.plotly_chart(fig, use_container_width=True)

# ğŸ“ˆ CorrelaÃ§Ã£o entre DuraÃ§Ã£o e VisualizaÃ§Ãµes
with tab2:
    st.subheader("â³ CorrelaÃ§Ã£o entre DuraÃ§Ã£o do VÃ­deo e VisualizaÃ§Ãµes")
    if df_filtered.empty:
        st.warning("âš ï¸ Nenhum dado disponÃ­vel para exibiÃ§Ã£o.")
    else:
        fig = px.scatter(df_filtered, x=df_filtered["duration_sec"] / 60, y="views", 
                         title="DuraÃ§Ã£o do VÃ­deo vs VisualizaÃ§Ãµes", 
                         labels={"x": "DuraÃ§Ã£o (minutos)", "y": "VisualizaÃ§Ãµes"})
        st.plotly_chart(fig, use_container_width=True)

# ğŸ’¬ ComparaÃ§Ã£o de Engajamento entre Shorts e Longos
with tab3:
    st.subheader("ğŸ’¬ ComparaÃ§Ã£o de Engajamento (Likes e ComentÃ¡rios) entre Shorts e Longos")
    if df_filtered.empty:
        st.warning("âš ï¸ Nenhum dado disponÃ­vel para este perÃ­odo.")
    else:
        df_engajamento = df_filtered.groupby("video_type")[["likes", "comments"]].mean().reset_index()
        fig = px.bar(df_engajamento, x="video_type", y=["likes", "comments"], barmode="group", 
                     title="Engajamento MÃ©dio por Tipo de VÃ­deo")
        st.plotly_chart(fig, use_container_width=True)

# ğŸ“… Desempenho por Dia da Semana
with tab4:
    st.subheader("ğŸ“… Desempenho por Dia da Semana")
    if df_filtered.empty:
        st.warning("âš ï¸ Nenhum dado disponÃ­vel para exibiÃ§Ã£o.")
    else:
        df_filtered["weekday"] = df_filtered["published_at"].dt.day_name()
        df_plot = df_filtered.groupby("weekday")["views"].mean().reset_index()
        fig = px.bar(df_plot, x="weekday", y="views", title="MÃ©dia de VisualizaÃ§Ãµes por Dia da Semana")
        st.plotly_chart(fig, use_container_width=True)

# ğŸ“ DistribuiÃ§Ã£o da DuraÃ§Ã£o dos VÃ­deos
with tab5:
    st.subheader("ğŸ“ DistribuiÃ§Ã£o da DuraÃ§Ã£o dos VÃ­deos")
    if df_filtered.empty:
        st.warning("âš ï¸ Nenhum dado disponÃ­vel para este perÃ­odo.")
    else:
        fig = px.histogram(df_filtered, x=df_filtered["duration_sec"] / 60, nbins=20, 
                           title="DistribuiÃ§Ã£o da DuraÃ§Ã£o dos VÃ­deos", labels={"x": "DuraÃ§Ã£o (minutos)"})
        st.plotly_chart(fig, use_container_width=True)

# Rodar o Streamlit:
# No terminal, execute: streamlit run app.py